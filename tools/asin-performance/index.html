<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ASIN Performance Analyzer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- Parsers -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root{--bg:#0b0d10;--panel:#11151a;--muted:#94a3b8;--text:#e5e7eb;--line:#1f2937;--brand:#22c55e;--ac:#0ea5e9}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(120deg,#0b0d10,#0f1720);color:var(--text);font-family:Inter,system-ui,Arial,sans-serif}
    .wrap{max-width:1200px;margin:32px auto;padding:0 16px}

    a.btn,button.btn{
      appearance:none;border:1px solid #344055;background:#0b1220;
      color:var(--text);padding:10px 14px;border-radius:10px;font-weight:600;text-decoration:none;cursor:pointer
    }
    .btn.primary{background:linear-gradient(135deg,var(--ac),var(--brand));border:none;color:#0b0d10}
    .btn.ghost{background:transparent;border:1px dashed #2a3441}

/* Stronger colors for Growth / Maintenance / Risk boxes */
.kpi.kpi-growth{
  background: rgba(34,197,94,.18);
  border: 1px solid rgba(34,197,94,.55);
  box-shadow: inset 0 0 0 2px rgba(34,197,94,.35);
}
.kpi.kpi-maint{
  background: rgba(234,179,8,.18);
  border: 1px solid rgba(234,179,8,.55);
  box-shadow: inset 0 0 0 2px rgba(234,179,8,.35);
}
.kpi.kpi-risk{
  background: rgba(239,68,68,.18);
  border: 1px solid rgba(239,68,68,.55);
  box-shadow: inset 0 0 0 2px rgba(239,68,68,.35);
}

    /* Dark, high-contrast toggle buttons for color bands */
    .btn.toggle{background:#0b1220;border-color:#3c4a61}
    .btn.toggle.active{background:#152033;border-color:#5b6b85;box-shadow:inset 0 0 0 1px #6a7a95}

    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px;margin-top:12px}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
    label{font-weight:600;display:block;margin:6px 0}
    input[type="text"],input[type="file"],textarea,select{
      width:100%;background:#0b1220;border:1px solid #2a3441;color:var(--text);border-radius:10px;padding:10px
    }

    table{width:100%;border-collapse:collapse;margin-top:10px;table-layout:fixed}
    th,td{border-bottom:1px solid var(--line);padding:10px;text-align:right;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    th:first-child,td:first-child,th:nth-child(2),td:nth-child(2),th:nth-child(3),td:nth-child(3){text-align:left;white-space:normal;overflow-wrap:anywhere}

    /* column resize handle */
    th{position:relative}
    .col-resize-handle{position:absolute;top:0;right:-2px;width:6px;height:100%;cursor:col-resize;user-select:none}
    .col-resize-handle:hover{background:linear-gradient(180deg,transparent 0%,#2a3441 40%,#2a3441 60%,transparent 100%)}

    /* Better title wrapping without tall rows */
    th.title,td.title{ text-align:left; white-space:normal; overflow-wrap:anywhere }
    th.title{ width:220px!important }
    td.title{ max-width:220px!important; line-height:1.2; display:-webkit-box; -webkit-line-clamp:1; -webkit-box-orient:vertical; overflow:hidden }

    .muted{color:var(--muted)}
    .bad{color:#f87171}
    .kpis{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
    .kpi{background:#0b1220;border:1px solid #2a3441;border-radius:12px;padding:10px}
    .kpi .v{font-size:20px;font-weight:700}

    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

    /* sorting indicators */
    thead th{font-size:11px;line-height:1.1;padding:6px 8px}
    tbody td{padding:8px 10px}
    th.sortable{cursor:pointer;user-select:none}
    th.sorted-asc::after{content:' ▲';font-size:10px;opacity:.7}
    th.sorted-desc::after{content:' ▼';font-size:10px;opacity:.7}

    /* per-column filters row */
    thead .filters th{padding:4px 6px}
    .col-filter{width:100%;background:#0b1220;border:1px solid #2a3441;color:var(--text);border-radius:8px;padding:6px;font-size:12px}

    /* columns panel */
    .cols-panel{position:fixed;right:24px;top:140px;background:#0b1220;border:1px solid #2a3441;border-radius:12px;padding:10px 12px;box-shadow:0 10px 30px rgba(0,0,0,.35);max-height:60vh;overflow:auto;display:none;min-width:260px;z-index:9999}
    .cols-panel h4{margin:6px 0 8px;font-size:13px}
    .cols-list{display:grid;grid-template-columns:1fr 1fr;gap:6px}
    .cols-list label{display:flex;align-items:center;gap:6px;font-size:12px;font-weight:500}
    .cols-actions{display:flex;gap:8px;margin-top:8px}
    .cols-actions .btn{padding:6px 10px;font-weight:600}
    .cols-hint{color:var(--muted);font-size:11px;margin-top:6px}

    /* Hide BR/SP detected chips row under the table (not used) */
    #tableCard .controls,#tableCard .controls *,#detectedBr,#detectedSp{display:none!important}

    /* === Darker, higher-contrast metric color bands === */
    td.heat-good{background:rgba(34,197,94,.28);border-left:3px solid rgba(34,197,94,.55)}
    td.heat-ok{background:rgba(234,179,8,.28);border-left:3px solid rgba(234,179,8,.55)}
    td.heat-bad{background:rgba(239,68,68,.28);border-left:3px solid rgba(239,68,68,.55)}

    /* Legend (darker) */
    .legend{display:flex;gap:8px;align-items:center;margin-bottom:6px}
    .legend .chip{border:1px solid #2a3441;background:#0b1220;border-radius:999px;padding:4px 8px;font-size:12px}
    .legend .chip.good{background:rgba(34,197,94,.28);border-color:rgba(34,197,94,.55)}
    .legend .chip.ok{background:rgba(234,179,8,.28);border-color:rgba(234,179,8,.55)}
    .legend .chip.bad{background:rgba(239,68,68,.28);border-color:rgba(239,68,68,.55)}
  </style>
</head>
<body>
  <div class="wrap">
    <a class="btn" href="../../">← Back to tools</a>
    <h1 style="margin:10px 0 6px">ASIN Performance Analyzer</h1>
    <p class="muted" style="margin:0 0 12px">Merge <strong>Amazon Business Reports</strong> with <strong>Sponsored Products</strong> to compute TACoS and ad contribution by ASIN. Supports a “Mapping” sheet for Category & Parent/Child mapping.</p>

    <div class="card">
      <div class="grid">
        <div>
          <label>Business Report (.csv or .xlsx) — can also contain a “Mapping” sheet</label>
          <input id="brFile" type="file" accept=".csv,.xlsx,.xls" />
        </div>
        <div>
          <label>Sponsored Products Report (.csv or .xlsx)</label>
          <input id="spFile" type="file" accept=".csv,.xlsx,.xls" />
        </div>
      </div>

      <div class="controls" style="margin-top:10px">
        <button class="btn primary" id="processBtn">Process</button>
        <button class="btn" id="downloadSample">Download sample CSVs</button>

        <select id="groupMode" style="max-width:220px">
          <option value="child" selected>Group: Child ASIN</option>
          <option value="parent">Group: Parent ASIN</option>
          <option value="category">Group: Category</option>
        </select>

        <input id="search" type="text" placeholder="Filter by ASIN, parent, title, or category…" style="flex:1;min-width:220px" />

        <!-- Column picker -->
        <button class="btn" id="colsBtn">Columns</button>

        <!-- Export -->
        <button class="btn ghost" id="exportBtn" disabled>Export CSV</button>

        <!-- New darker color-band toggles -->
        <button class="btn toggle active" id="bandConvBtn" aria-pressed="true" title="Toggle color bands for Ad Conv % and Org Conv %">Conv Bands</button>
        <button class="btn toggle active" id="bandTacosBtn" aria-pressed="true" title="Toggle color bands for TACoS %">TACoS Bands</button>
        <button class="btn toggle active" id="bandSpendBtn" aria-pressed="true" title="Toggle color bands for SP Spend">Spend Bands</button>
      </div>

      <div id="errors" class="bad" style="margin-top:6px"></div>
    </div>

    <div class="card" id="kpiCard" style="display:none">
      <div class="kpis">
        <div class="kpi"><div class="muted">SP Spend</div><div class="v" id="kSpend">0.00</div></div>
        <div class="kpi"><div class="muted">SP Sales</div><div class="v" id="kSpSales">0.00</div></div>
        <div class="kpi"><div class="muted">BR Sales (Total)</div><div class="v" id="kBrSales">0.00</div></div>
        <div class="kpi"><div class="muted">TACoS %</div><div class="v" id="kTacos">0.00</div></div>
        <div class="kpi"><div class="muted">ACOS %</div><div class="v" id="kAcos">0.00</div></div>
      </div>
    </div>

    <!-- New: mode-aware TACoS summary buckets -->
    <div class="card" id="summaryCard" style="display:none">
      <div class="kpis">
       <div class="kpi kpi-growth">
  <div class="muted">Growth (< 5% TACoS)</div>

          <div class="v" id="sumGrowthCount">0</div>
          <div class="muted" id="sumGrowthList" style="font-size:12px;line-height:1.35;margin-top:6px"></div>
        </div>
      <div class="kpi kpi-maint">
  <div class="muted">Maintenance (5–25% TACoS)</div>

          <div class="v" id="sumMaintCount">0</div>
          <div class="muted" id="sumMaintList" style="font-size:12px;line-height:1.35;margin-top:6px"></div>
        </div>
        <div class="kpi kpi-risk">
  <div class="muted">High Risk (> 25% TACoS)</div>
          <div class="v" id="sumRiskCount">0</div>
          <div class="muted" id="sumRiskList" style="font-size:12px;line-height:1.35;margin-top:6px"></div>
        </div>
      </div>
    </div>

    <div class="card" id="tableCard" style="display:none">
      <!-- Legend for color bands -->
      <div class="legend" id="heatLegend">
        <span class="chip good">Good</span>
        <span class="chip ok">Okay</span>
        <span class="chip bad">Needs attention</span>
      </div>
      <div id="tableOut"></div>
    </div>
  </div>

  <div id="colsPanel" class="cols-panel"></div>

  <script>
  // ---------- Helpers ----------
  const qs = (id)=>document.getElementById(id);
  const num = (v)=>{ if(v===undefined||v===null||v==='') return 0; if(typeof v==='number') return v; return parseFloat(String(v).replace(/[^0-9.-]/g,''))||0; };
  const fmt0=(n)=> (n||0).toLocaleString();
  const fmt2=(n)=> (n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  function truncateTitle(s, max = 60) { const t = (s || '').trim(); return t.length > max ? t.slice(0, max - 1) + '…' : t; }

  // quantile helper for spend heat
  function quantileSorted(arr,q){ if(!arr.length) return 0; const pos=(arr.length-1)*q; const base=Math.floor(pos); const rest=pos-base; const next=arr[base+1]; return next!==undefined? arr[base]+rest*(next-arr[base]) : arr[base]; }

  // === Color-band thresholds (tune here) ===
  const HEAT_RULES = {
    // ACOS & ROAS (always active)
    acos:   v => Num(v) <= 20 ? 'good' : (Num(v) <= 35 ? 'ok' : 'bad'),
    roas:   v => Num(v) >= 4  ? 'good' : (Num(v) >= 2 ? 'ok' : 'bad'),

    // Conversions (controlled by Conv toggle)
    adConv: v => Num(v) >= 15 ? 'good' : (Num(v) >= 8 ? 'ok' : 'bad'),
    orgConv:v => Num(v) >= 12 ? 'good' : (Num(v) >= 6 ? 'ok' : 'bad'),

    // TACoS (controlled by TACoS toggle)
    tacos:  v => Num(v) <= 12 ? 'good' : (Num(v) <= 20 ? 'ok' : 'bad')
    // spend uses dynamic quantiles; handled separately
  };
  function Num(x){ return typeof x==='number' ? x : parseFloat(x)||0; }

  // Band toggles
  let BAND_CONV = true;   // affects adConv & orgConv
  let BAND_TACOS = true;  // affects tacos
  let BAND_SPEND = true;  // affects spend
  function heatEnabledFor(key){
    if(key==='adConv' || key==='orgConv') return BAND_CONV;
    if(key==='tacos') return BAND_TACOS;
    if(key==='spend') return BAND_SPEND;
    return true; // ACOS/ROAS stay colored; change to false if you want them controlled too
  }
  function heatClassFor(key, rawValue){
    if(!heatEnabledFor(key)) return '';
    // Dynamic spend bands based on current (filtered) list
    if(key==='spend' && window._spendBands){
      const {q40,q80,min,max} = window._spendBands;
      if(max===min) return '';
      const v = Num(rawValue);
      if(v<=q40) return 'heat-good';
      if(v<=q80) return 'heat-ok';
      return 'heat-bad';
    }
    const rule = HEAT_RULES[key];
    if(!rule) return '';
    const band = rule(rawValue);
    if(!band) return '';
    return band==='good' ? 'heat-good' : band==='ok' ? 'heat-ok' : 'heat-bad';
  }

  // ---------- Expected columns ----------
  const BR = {
    parent:["(Parent) ASIN","Parent ASIN","Parent"],
    child:["(Child) ASIN","Child ASIN","ASIN","Child"],
    title:["Title"],
    sessions:["Sessions - Total","Sessions"],
    pageviews:["Page Views - Total","Page Views"],
    buybox:["Featured Offer (Buy Box) Percentage","Featured Offer Percentage","Buy Box Percentage"],
    units:["Units Ordered"],
    unitSession:["Unit Session Percentage"],
    sales:["Ordered Product Sales","Sales (Total)","Sales"],
    orders:["Total Order Items","Orders"]
  };

  const SP = {
    entity:["Entity","Record Type","Record_Type"],
    asin:["ASIN (Informational only)","ASIN","Advertised ASIN","Advertised ASIN (Informational only)"],
    impressions:["Impressions"],
    clicks:["Clicks"],
    spend:["Spend","Cost"],
    sales:["Sales","7 Day Total Sales"],
    orders:["Orders","7 Day Total Orders"],
    units:["Units","7 Day Total Units"]
  };

  // Mapping expected headers
  const MAP = { parent:["Parent","Parent ASIN"], child:["Child Asin","Child ASIN","ASIN"], category:["Category Name","Category","Cat"] };

  // ---------- Readers ----------
  function findHeader(headers, candidates){
    const H = headers.map(h=>String(h).trim());
    for(const cand of candidates){
      const idx = H.findIndex(h => h.toLowerCase()===cand.toLowerCase());
      if(idx!==-1) return H[idx];
      const normCand = cand.toLowerCase().replace(/[^a-z0-9]+/g,'');
      const idx2 = H.findIndex(h=> h.toLowerCase().replace(/[^a-z0-9]+/g,'')===normCand);
      if(idx2!==-1) return H[idx2];
    }
    return '';
  }
  function mapHeaders(headers, def){ const out={}; for(const k of Object.keys(def)){ out[k] = findHeader(headers, def[k]); } return out; }

  function readCsv(file){
    return new Promise((resolve,reject)=>{
      Papa.parse(file,{header:true,skipEmptyLines:true,complete:r=>resolve({rows:r.data,headers:r.meta.fields||[],sheet:'CSV'}),error:reject});
    });
  }

  async function readWorkbookWithMapping(file){
    const data = await file.arrayBuffer();
    const wb = XLSX.read(new Uint8Array(data),{type:'array'});

    let best = {name: wb.SheetNames[0], headers: [], rows: [], score: -1};
    for (const name of wb.SheetNames){
      const ws = wb.Sheets[name];
      const rows2D = XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
      let headerRowIndex = 0;
      for (let i=0;i<rows2D.length;i++){
        const row = (rows2D[i]||[]).map(String);
        const joined = row.join(' ').toLowerCase();
        const nonEmpty = row.filter(c=>String(c).trim()!=='').length;
        if (nonEmpty>=5 && (joined.includes('impressions')||joined.includes('asin')||joined.includes('clicks')||joined.includes('campaign id')||joined.includes('spend')||joined.includes('sales'))){
          headerRowIndex=i; break;
        }
      }
      const headers = (rows2D[headerRowIndex]||[]).map(String);
      const rows = XLSX.utils.sheet_to_json(wb.Sheets[name],{range: headerRowIndex+1, header: headers, defval:''});
      const score = headers.reduce((a,h)=>{const x=h.toLowerCase();return a + (x.includes('asin')||x.includes('impressions')||x.includes('spend')||x.includes('sales')||x.includes('clicks')?1:0);},0);
      if (score>best.score) best = {name, headers, rows, score};
    }

    // Mapping sheet by name or by headers
    let mapping = [];
    for (const name of wb.SheetNames){
      if (String(name).toLowerCase().includes('mapping')){
        const headers = XLSX.utils.sheet_to_json(wb.Sheets[name],{header:1,defval:''})[0]||[];
        const rows = XLSX.utils.sheet_to_json(wb.Sheets[name],{range:1,header:headers,defval:''});
        mapping = rows; break;
      }
    }
    if (!mapping.length){
      for (const name of wb.SheetNames){
        const headersRow = XLSX.utils.sheet_to_json(wb.Sheets[name],{header:1,defval:''})[0]||[];
        const hasParent = headersRow.some(h=>MAP.parent.some(c=>c.toLowerCase()===String(h).trim().toLowerCase()));
        const hasCat = headersRow.some(h=>MAP.category.some(c=>c.toLowerCase()===String(h).trim().toLowerCase()));
        if (hasParent && hasCat){
          const rows = XLSX.utils.sheet_to_json(wb.Sheets[name],{range:1,header:headersRow,defval:''});
          mapping = rows; break;
        }
      }
    }
    return {main: best, mapping};
  }

  async function readBR(file){
    const ext=(file.name.split('.').pop()||'').toLowerCase();
    if (ext==='csv') {
      const main = await readCsv(file);
      return {main, mapping: []};
    }
    return await readWorkbookWithMapping(file);
  }

  async function readSP(file){
    const ext=(file.name.split('.').pop()||'').toLowerCase();
    if (ext==='csv') return await readCsv(file);
    const data = await file.arrayBuffer();
    const wb = XLSX.read(new Uint8Array(data),{type:'array'});
    let best = {name: wb.SheetNames[0], headers: [], rows: [], score: -1};
    for (const name of wb.SheetNames){
      const ws = wb.Sheets[name];
      const rows2D = XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
      let headerRowIndex = 0;
      for (let i=0;i<rows2D.length;i++){
        const row = (rows2D[i]||[]).map(String);
        const joined = row.join(' ').toLowerCase();
        const nonEmpty = row.filter(c=>String(c).trim()!=='').length;
        if (nonEmpty>=5 && (joined.includes('impressions')||joined.includes('asin')||joined.includes('clicks')||joined.includes('campaign id')||joined.includes('spend')||joined.includes('sales'))){
          headerRowIndex=i; break;
        }
      }
      const headers = (rows2D[headerRowIndex]||[]).map(String);
      const rows = XLSX.utils.sheet_to_json(wb.Sheets[name],{range: headerRowIndex+1, header: headers, defval:''});
      const score = headers.reduce((a,h)=>{const x=h.toLowerCase();return a + (x.includes('asin')||x.includes('impressions')||x.includes('spend')||x.includes('sales')||x.includes('clicks')?1:0);},0);
      if (score>best.score) best = {name, headers, rows, score};
    }
    return best;
  }

  // ---------- Processing ----------
  async function process(){
    qs('errors').textContent='';
    const brFile = qs('brFile').files[0];
    const spFile = qs('spFile').files[0];
    if(!brFile || !spFile){ qs('errors').textContent='Please choose both files (Business Report + Sponsored Products).'; return; }

    try{
      const [{main:BRdata, mapping:mappingRows}, SPdata] = await Promise.all([readBR(brFile), readSP(spFile)]);
      const brCols = mapHeaders(BRdata.headers, BR);
      const spCols = mapHeaders(SPdata.headers, SP);

      if(!brCols.child || !brCols.sales){
        throw new Error('Business Report missing required columns (ASIN and Ordered Product Sales).');
      }
      if(!spCols.asin || !spCols.spend){
        throw new Error('Sponsored Products missing required columns (ASIN and Spend).');
      }

      // Build category maps from Mapping sheet
      const mapCols = mappingRows.length ? mapHeaders(Object.keys(mappingRows[0]||{}), MAP) : {};
      const parentToCat = new Map();
      const childToCat  = new Map();
      if (mappingRows.length && mapCols.parent && mapCols.category){
        for (const r of mappingRows){
          const p = String(r[mapCols.parent]||'').trim().toUpperCase();
          const c = (mapCols.child? String(r[mapCols.child]||'').trim().toUpperCase() : '');
          const cat = String(r[mapCols.category]||'').trim();
          if (!p && !c) continue;
          if (c) childToCat.set(c, cat);
          if (p && cat) parentToCat.set(p, cat);
        }
      }

      function inferCategory(parentAsin, childAsin){
        const c = (childAsin||'').toUpperCase();
        const p = (parentAsin||'').toUpperCase();
        return childToCat.get(c) || parentToCat.get(p) || '(Unmapped)';
      }

      // Aggregate BR (child rows)
      const brAgg = {};
      for(const r of BRdata.rows){
        const child = String(r[brCols.child]||'').trim().toUpperCase();
        if(!child) continue;
        const parent = String(r[brCols.parent]||'').trim().toUpperCase();
        const title  = String(r[brCols.title]||'').trim();
        const o = brAgg[child] ||= {
          asin:child,parent:'',title:'',
          sessions:0,pageviews:0,buybox:0,units:0,unitSession:0,brSales:0,orders:0
        };
        o.parent = o.parent || parent;
        o.title  = o.title  || title;
        o.sessions += num(r[brCols.sessions]);
        o.pageviews += num(r[brCols.pageviews]);
        o.buybox += num(r[brCols.buybox]);
        o.units += num(r[brCols.units]);
        o.unitSession += num(r[brCols.unitSession]);
        o.brSales += num(r[brCols.sales]);
        o.orders  += num(r[brCols.orders]); // BR Orders
      }

      // Aggregate SP (child rows; only Product Ad rows if entity present)
      const spAgg = {};
      for(const r of SPdata.rows){
        if (spCols.entity){
          const ent = String(r[spCols.entity]||'').trim().toLowerCase();
          if (ent && !(ent.includes('product') && ent.includes('ad'))) continue;
        }
        const asin = String(r[spCols.asin]||'').trim().toUpperCase();
        if(!asin) continue;
        const o = spAgg[asin] ||= {asin,impressions:0,clicks:0,spend:0,sales:0,orders:0,units:0};
        o.impressions += num(r[spCols.impressions]);
        o.clicks      += num(r[spCols.clicks]);
        o.spend       += num(r[spCols.spend]);
        o.sales       += num(r[spCols.sales]);
        o.orders      += num(r[spCols.orders]);
        o.units       += num(r[spCols.units]);
      }

      // Merge BR + SP by child ASIN, attach category + conversions
      const keys = Array.from(new Set([...Object.keys(brAgg), ...Object.keys(spAgg)])).sort();
      let childRows = keys.map(k=>{
        const b = brAgg[k]||{asin:k};
        const s = spAgg[k]||{};
        const impressions = s.impressions||0,
              clicks      = s.clicks||0,
              spend       = s.spend||0,
              sSales      = s.sales||0,
              sOrders     = s.orders||0,
              sUnits      = s.units||0;
        const brSales  = b.brSales||0;
        const brOrders = b.orders||0;
        const adConv   = clicks ? (sOrders/clicks*100) : 0;              // SP Orders / SP Clicks
        const orgConv  = (b.sessions||0) ? (brOrders/b.sessions*100) : 0;// BR Orders / BR Sessions
        const acos     = sSales? (spend/sSales*100):0;
        const roas     = spend? (sSales/spend):0;
        const tacos    = brSales? (spend/brSales*100):0;
        const category = inferCategory(b.parent, k);
        return {
          asin:k,
          parent:b.parent||'',
          title:b.title||'',
          category,
          sessions:b.sessions||0,
          pageviews:b.pageviews||0,
          buybox:b.buybox||0,
          units:b.units||0,
          unitSession:b.unitSession||0,
          brSales, brOrders,
          impressions, clicks, spend, sSales, sOrders, sUnits,
          adConv, orgConv, acos, roas, tacos
        };
      });

      // ---- rollups
      let parentRows  = rollupToParent(childRows, parentToCat);
      let categoryRows= rollupToCategory(childRows);

      // KPIs on child set (global totals)
      const totalsChild = computeTotals(childRows);
      const kAcos = totalsChild.sSales? totalsChild.spend/totalsChild.sSales*100 : 0;
      const kTacos= totalsChild.brSales? totalsChild.spend/totalsChild.brSales*100 : 0;

      qs('kSpend').textContent = fmt2(totalsChild.spend);
      qs('kSpSales').textContent= fmt2(totalsChild.sSales);
      qs('kBrSales').textContent= fmt2(totalsChild.brSales);
      qs('kAcos').textContent   = fmt2(kAcos);
      qs('kTacos').textContent  = fmt2(kTacos);
      qs('kpiCard').style.display='block';

      // Add % of total Sales/Spend for each mode
      const totalsParent   = computeTotals(parentRows);
      const totalsCategory = computeTotals(categoryRows);
      childRows    = addShares(childRows, totalsChild);
      parentRows   = addShares(parentRows, totalsParent);
      categoryRows = addShares(categoryRows, totalsCategory);

      // cache + initial render
      window._rowsChild = childRows;
      window._rowsParent = parentRows;
      window._rowsCategory = categoryRows;

      const mode = qs('groupMode').value;
      const data = mode==='parent' ? parentRows : (mode==='category' ? categoryRows : childRows);
      window._rows = data;

      renderTable(data, mode);
      qs('exportBtn').disabled=false;
      qs('exportBtn').onclick=()=> exportCsv(window._rendered||data, mode, window._lastColsUsed);
      qs('colsBtn').disabled=false;
      buildColsPanel(mode);

    }catch(err){
      console.error(err);
      qs('errors').textContent = err.message || String(err);
    }
  }

  // ---- totals & shares helpers
  function computeTotals(rows){
    return rows.reduce((a,r)=>({
      impressions:a.impressions+(r.impressions||0),
      clicks:a.clicks+(r.clicks||0),
      spend:a.spend+(r.spend||0),
      sSales:a.sSales+(r.sSales||0),
      sOrders:a.sOrders+(r.sOrders||0),
      sUnits:a.sUnits+(r.sUnits||0),
      brSales:a.brSales+(r.brSales||0)
    }),{impressions:0,clicks:0,spend:0,sSales:0,sOrders:0,sUnits:0,brSales:0});
  }
  function addShares(rows, totals){
    return rows.map(r=>({
      ...r,
      brSalesShare: totals.brSales ? (r.brSales / totals.brSales * 100) : 0,
      spendShare:   totals.spend   ? (r.spend   / totals.spend   * 100) : 0
    }));
  }

  // ---- rollup: Parent (with auto-generated truncated title)
  function rollupToParent(childRows, parentToCatMap){
    const map={};
    for(const r of childRows){
      const key = r.parent || '(No parent)';
      if(!map[key]){
        map[key] = {
          parent:key,
          firstChildTitle:'',
          title:'',
          category: (parentToCatMap && parentToCatMap.get((r.parent||'').toUpperCase())) || r.category || '(Unmapped)',
          childSet:new Set(),
          sessions:0,pageviews:0,buybox:0,units:0,unitSession:0,
          brSales:0,brOrders:0,
          impressions:0,clicks:0,spend:0,sSales:0,sOrders:0,sUnits:0
        };
      }
      const m=map[key];
      m.childSet.add(r.asin);
      if(!m.firstChildTitle && r.title) m.firstChildTitle = r.title;

      m.sessions+=r.sessions||0; m.pageviews+=r.pageviews||0; m.buybox+=r.buybox||0; m.units+=r.units||0; m.unitSession+=r.unitSession||0;
      m.brSales+=r.brSales||0;   m.brOrders+=r.brOrders||0;
      m.impressions+=r.impressions||0; m.clicks+=r.clicks||0; m.spend+=r.spend||0; m.sSales+=r.sSales||0; m.sOrders+=r.sOrders||0; m.sUnits+=r.sUnits||0;
    }
    return Object.values(map).map(m=>{
      let t = (m.title || m.firstChildTitle || '').trim();
      if (!t) t = `${m.parent} (${m.childSet.size} variants)`;
      t = truncateTitle(t, 60);

      const adConv = m.clicks ? (m.sOrders/m.clicks*100) : 0;
      const orgConv= m.sessions ? (m.brOrders/m.sessions*100) : 0;
      const acos   = m.sSales? (m.spend/m.sSales*100):0;
      const roas   = m.spend? (m.sSales/m.spend):0;
      const tacos  = m.brSales? (m.spend/m.brSales*100):0;

      return {
        parent:m.parent, title:t, category:m.category, childCount:m.childSet.size,
        brSales:m.brSales, brOrders:m.brOrders,
        sessions:m.sessions, pageviews:m.pageviews, units:m.units,
        impressions:m.impressions, clicks:m.clicks, spend:m.spend,
        sSales:m.sSales, sOrders:m.sOrders, sUnits:m.sUnits,
        adConv, orgConv, acos, roas, tacos
      };
    });
  }

  // ---- rollup: Category
  function rollupToCategory(childRows){
    const map = {};
    for(const r of childRows){
      const key = r.category || '(Unmapped)';
      if(!map[key]){
        map[key] = {
          category:key,
          sessions:0,pageviews:0,buybox:0,units:0,unitSession:0,
          brSales:0,brOrders:0,
          impressions:0,clicks:0,spend:0,sSales:0,sOrders:0,sUnits:0
        };
      }
      const m=map[key];
      m.sessions+=r.sessions||0; m.pageviews+=r.pageviews||0; m.buybox+=r.buybox||0; m.units+=r.units||0; m.unitSession+=r.unitSession||0;
      m.brSales+=r.brSales||0;   m.brOrders+=r.brOrders||0;
      m.impressions+=r.impressions||0; m.clicks+=r.clicks||0; m.spend+=r.spend||0; m.sSales+=r.sSales||0; m.sOrders+=r.sOrders||0; m.sUnits+=r.sUnits||0;
    }
    return Object.values(map).map(m=>{
      const adConv = m.clicks ? (m.sOrders/m.clicks*100) : 0;
      const orgConv= m.sessions ? (m.brOrders/m.sessions*100) : 0;
      const acos   = m.sSales? (m.spend/m.sSales*100):0;
      const roas   = m.spend? (m.sSales/m.spend):0;
      const tacos  = m.brSales? (m.spend/m.brSales*100):0;
      return {
        category:m.category,
        brSales:m.brSales, brOrders:m.brOrders,
        sessions:m.sessions, pageviews:m.pageviews, units:m.units,
        impressions:m.impressions, clicks:m.clicks, spend:m.spend,
        sSales:m.sSales, sOrders:m.sOrders, sUnits:m.sUnits,
        adConv, orgConv, acos, roas, tacos
      };
    });
  }

  // ---------- Columns ----------
  const COLS = {
    child:[
      {key:'asin',label:'Child ASIN'},
      {key:'parent',label:'Parent ASIN'},
      {key:'category',label:'Category'},
      {key:'title',label:'Title',class:'title'},
      {key:'brSales',label:'BR Sales',fmt:'2'},
      {key:'brSalesShare',label:'% of Total Sales',fmt:'2',pct:true},
      {key:'brOrders',label:'BR Orders',fmt:'0'},
      {key:'sessions',label:'BR Sessions',fmt:'0'},
      {key:'spend',label:'SP Spend',fmt:'2'},
      {key:'spendShare',label:'% of Total Spend',fmt:'2',pct:true},
      {key:'sSales',label:'SP Sales',fmt:'2'},
      {key:'sOrders',label:'SP Orders',fmt:'0'},
      {key:'adConv',label:'Ad Conv %',fmt:'2'},
      {key:'orgConv',label:'Org Conv %',fmt:'2'},
      {key:'acos',label:'ACOS %',fmt:'2'},
      {key:'roas',label:'ROAS',fmt:'2'},
      {key:'tacos',label:'TACoS %',fmt:'2'}
    ],
    parent:[
      {key:'parent',label:'Parent ASIN'},
      {key:'category',label:'Category'},
      {key:'title',label:'Title',class:'title'},
      {key:'childCount',label:'# Children',fmt:'0'},
      {key:'brSales',label:'BR Sales',fmt:'2'},
      {key:'brSalesShare',label:'% of Total Sales',fmt:'2',pct:true},
      {key:'brOrders',label:'BR Orders',fmt:'0'},
      {key:'sessions',label:'BR Sessions',fmt:'0'},
      {key:'spend',label:'SP Spend',fmt:'2'},
      {key:'spendShare',label:'% of Total Spend',fmt:'2',pct:true},
      {key:'sSales',label:'SP Sales',fmt:'2'},
      {key:'sOrders',label:'SP Orders',fmt:'0'},
      {key:'adConv',label:'Ad Conv %',fmt:'2'},
      {key:'orgConv',label:'Org Conv %',fmt:'2'},
      {key:'acos',label:'ACOS %',fmt:'2'},
      {key:'roas',label:'ROAS',fmt:'2'},
      {key:'tacos',label:'TACoS %',fmt:'2'}
    ],
    category:[
      {key:'category',label:'Category'},
      {key:'brSales',label:'BR Sales',fmt:'2'},
      {key:'brSalesShare',label:'% of Total Sales',fmt:'2',pct:true},
      {key:'brOrders',label:'BR Orders',fmt:'0'},
      {key:'sessions',label:'BR Sessions',fmt:'0'},
      {key:'spend',label:'SP Spend',fmt:'2'},
      {key:'spendShare',label:'% of Total Spend',fmt:'2',pct:true},
      {key:'sSales',label:'SP Sales',fmt:'2'},
      {key:'sOrders',label:'SP Orders',fmt:'0'},
      {key:'adConv',label:'Ad Conv %',fmt:'2'},
      {key:'orgConv',label:'Org Conv %',fmt:'2'},
      {key:'acos',label:'ACOS %',fmt:'2'},
      {key:'roas',label:'ROAS',fmt:'2'},
      {key:'tacos',label:'TACoS %',fmt:'2'}
    ]
  };

  // Title is toggleable; keep essential IDs minimal
  const ESSENTIAL = { child:['asin','parent'], parent:['parent'], category:['category'] };

  function getVisibleCols(mode){
    if(mode==='parent') return (window._visibleParent ||= COLS.parent.map(c=>c.key));
    if(mode==='category') return (window._visibleCat    ||= COLS.category.map(c=>c.key));
    return (window._visibleChild ||= COLS.child.map(c=>c.key));
  }
  function setVisibleCols(mode, arr){
    if(mode==='parent') window._visibleParent = arr;
    else if(mode==='category') window._visibleCat = arr;
    else window._visibleChild = arr;
  }

  function buildColsPanel(mode){
    const panel = qs('colsPanel');
    const cols = COLS[mode];
    const vis = new Set(getVisibleCols(mode));
    const essential = new Set(ESSENTIAL[mode]);
    panel.innerHTML = `
      <h4>Visible columns (${mode})</h4>
      <div class="cols-list">
        ${cols.map(c=>{
          const checked = vis.has(c.key) ? 'checked' : '';
          const disabled = essential.has(c.key) ? 'disabled' : '';
          return `<label><input type="checkbox" data-key="${c.key}" ${checked} ${disabled}/> ${c.label}</label>`;
        }).join('')}
      </div>
      <div class="cols-actions">
        <button class="btn" id="colsAll">Select all</button>
        <button class="btn ghost" id="colsReset">Reset</button>
        <button class="btn" id="colsClose">Close</button>
      </div>
      <div class="cols-hint">Required columns are locked.</div>`;

    panel.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
      cb.addEventListener('change', ()=>{
        const cur = new Set(getVisibleCols(mode));
        if(cb.checked) cur.add(cb.dataset.key); else cur.delete(cb.dataset.key);
        ESSENTIAL[mode].forEach(k=>cur.add(k));
        setVisibleCols(mode, Array.from(cur));
        if(window._rows){ renderTable(window._rows, mode); }
      });
    });
    panel.querySelector('#colsAll').onclick=()=>{
      const all = COLS[mode].map(c=>c.key);
      setVisibleCols(mode, all);
      buildColsPanel(mode); if(window._rows) renderTable(window._rows, mode);
    };
    panel.querySelector('#colsReset').onclick=()=>{
      setVisibleCols(mode, COLS[mode].map(c=>c.key));
      buildColsPanel(mode); if(window._rows) renderTable(window._rows, mode);
    };
    panel.querySelector('#colsClose').onclick=()=>{ panel.style.display='none'; };
  }
  function toggleColsPanel(){
    const panel = qs('colsPanel');
    if(!panel.innerHTML.trim()) buildColsPanel(qs('groupMode').value);
    panel.style.display = panel.style.display==='block' ? 'none' : 'block';
  }

  // ---------- Rendering ----------
  function sortList(list){
    const s = window._sort||{}; if(!s.key) return list;
    const numeric = new Set([
      'childCount','brSales','brOrders','units','sessions','pageviews',
      'impressions','clicks','spend','sSales','sOrders','sUnits',
      'adConv','orgConv','acos','cpc','roas','tacos','buybox','unitSession','brSalesShare','spendShare'
    ]);
    const key = s.key; const dir = s.dir==='asc'?'asc':'desc';
    const arr = list.slice();
    arr.sort((a,b)=>{
      let va=a[key], vb=b[key];
      if(numeric.has(key)){ va=Number(va)||0; vb=Number(vb)||0; }
      else { va=(va||'').toString().toLowerCase(); vb=(vb||'').toString().toLowerCase(); }
      if(va<vb) return dir==='asc'?-1:1; if(va>vb) return dir==='asc'?1:-1; return 0;
    });
    return arr;
  }

  function enableHeaderSort(container, mode){
    const table = container.querySelector('table'); if(!table||!table.tHead) return;
    const ths = Array.from(table.tHead.rows[0].cells);
    ths.forEach(th=>{
      const key = th.getAttribute('data-key'); if(!key) return;
      th.addEventListener('click', (e)=>{
        if(e.target.classList.contains('col-resize-handle')) return;
        const cur = window._sort||{}; let dir = 'desc';
        if(cur.key===key && cur.dir==='desc') dir='asc';
        window._sort = {key, dir, mode};
        if(window._rows) renderTable(window._rows, mode);
      });
    });
  }

  function getColFilters(mode){ return (window._colFilters ||= {[mode]:{}})[mode] ||= {}; }
  function setColFilters(mode, ft){ (window._colFilters ||= {})[mode] = ft; }

// === Numeric filter helpers ===
const NUMERIC_KEYS = new Set([
  'childCount','brSales','brOrders','units','sessions','pageviews',
  'impressions','clicks','spend','sSales','sOrders','sUnits',
  'adConv','orgConv','acos','roas','tacos','buybox','unitSession',
  'brSalesShare','spendShare'
]);
function isNumericColumn(key){ return NUMERIC_KEYS.has(key); }
function parseNum(x){
  if(x==null) return 0;
  return typeof x==='number' ? x : parseFloat(String(x).replace(/[^0-9.-]/g,''))||0;
}
// Supports: >x, >=x, <x, <=x, =x, ==x, !=x, a-b (inclusive). Optional trailing %.
function matchNumeric(value, expr){
  const v = parseNum(value);
  let e = String(expr).trim();
  if(!e) return true;
  e = e.replace(/\s+/g,'');
  if(e.endsWith('%')) e = e.slice(0,-1);
  const mRange = e.match(/^(-?\d+(?:\.\d+)?)\-(-?\d+(?:\.\d+)?)$/);
  if(mRange){
    const a = parseFloat(mRange[1]), b = parseFloat(mRange[2]);
    return v >= Math.min(a,b) && v <= Math.max(a,b);
  }
  const mOp = e.match(/^(<=|>=|<|>|==|=|!=)(-?\d+(?:\.\d+)?)$/);
  if(mOp){
    const op = mOp[1], n = parseFloat(mOp[2]);
    if(op==='>')  return v>n;
    if(op==='<')  return v<n;
    if(op==='>=') return v>=n;
    if(op==='<=') return v<=n;
    if(op==='='||op==='==') return v===n;
    if(op==='!=') return v!==n;
  }
  const n = parseFloat(e);
  if(!Number.isNaN(n)) return Math.abs(v-n) < 1e-9;
  return false;
}

  function updateSummary(list, mode){
    const id = (r)=> mode==='child' ? r.asin : (mode==='parent' ? r.parent : r.category);
    const growth = [], maint = [], risk = [];
    for(const r of list){
      if((r.tacos||0) < 5) growth.push(r);
      else if((r.tacos||0) > 25) risk.push(r);
      else maint.push(r);
    }
    const topN = (arr)=> arr.sort((a,b)=> (b.brSales||0) - (a.brSales||0)).slice(0,5).map(x=> `${id(x)} — ${fmt2(x.tacos||0)}% TACoS`).join('<br>');
    qs('sumGrowthCount').textContent = growth.length;
    qs('sumMaintCount').textContent  = maint.length;
    qs('sumRiskCount').textContent   = risk.length;
    qs('sumGrowthList').innerHTML = growth.length? topN(growth) : '<span class="muted">—</span>';
    qs('sumMaintList').innerHTML  = maint.length?  topN(maint)  : '<span class="muted">—</span>';
    qs('sumRiskList').innerHTML   = risk.length?   topN(risk)   : '<span class="muted">—</span>';
    qs('summaryCard').style.display='block';
  }

  function renderTable(rows, mode='child'){
    const qv = (qs('search').value||'').trim().toLowerCase();

    const visible = getVisibleCols(mode);
    const cols = COLS[mode].filter(c=> visible.includes(c.key));
    window._lastColsUsed = cols;

    const filters = getColFilters(mode);
   const filtered = rows.filter(r=>{
  if(qv){
    const hay = [r.asin, r.parent, r.title, r.category].filter(Boolean).join(' ').toLowerCase();
    if(!hay.includes(qv)) return false;
  }
  for(const c of cols){
    const f = (filters[c.key]||'').trim();
    if(!f) continue;
    const v = r[c.key];
    if(isNumericColumn(c.key)){
      if(!matchNumeric(v, f)) return false;
    }else{
      const vs = (v==null?'':String(v)).toLowerCase();
      if(!vs.includes(f.toLowerCase())) return false;
    }
  }
  return true;
});


    // Compute spend quantiles for dynamic heat (on the filtered slice)
    const spendVals = filtered.map(r=> Number(r.spend)||0 ).filter(v=> v>=0 ).sort((a,b)=>a-b);
    if(spendVals.length>=3){
      const q40 = quantileSorted(spendVals,0.40);
      const q80 = quantileSorted(spendVals,0.80);
      window._spendBands = {q40,q80,min:spendVals[0],max:spendVals[spendVals.length-1]};
    } else {
      window._spendBands = null;
    }

    const list = sortList(filtered);
    window._rendered = list;

    // Update TACoS summary block (mode-aware, after filters/search)
    updateSummary(list, mode);

    const headTop = `<tr>` + cols.map(c=>{
      const sorted = (window._sort && window._sort.key===c.key) ? ('sorted-'+window._sort.dir) : '';
      return `<th class="${(c.class||'')} sortable ${sorted}" data-key="${c.key}">${c.label}</th>`;
    }).join('') + `</tr>`;

    const headFilters = `<tr class="filters">` + cols.map(c=>{
  const val = (filters[c.key]||'');
  const ph  = isNumericColumn(c.key) ? '>, >=, <, <=, =, 10-20' : 'filter…';
  return `<th><input class="col-filter" data-key="${c.key}" value="${val}" placeholder="${ph}" title="${ph}"></th>`;
}).join('') + `</tr>`;


    const head = `<table><thead>${headTop}${headFilters}</thead><tbody>`;

    const body = list.map(r=> `<tr>` +
      cols.map(c=>{
        const raw = r[c.key]; // keep raw for heat banding
        let v = raw;
        if(c.pct) v = `${fmt2(raw)} %`;
        else if(c.fmt==='2') v = fmt2(raw);
        else if(c.fmt==='0') v = fmt0(raw);
        else v = (raw ?? '');
        const heat = heatClassFor(c.key, raw);
        const cls = [c.class||'', heat].filter(Boolean).join(' ');
        return `<td class="${cls}">${v}</td>`;
      }).join('') + `</tr>`
    ).join('');

    const html = head + body + `</tbody></table>`;
    qs('tableOut').innerHTML = html;
    qs('tableCard').style.display='block';

    qs('tableOut').querySelectorAll('.col-filter').forEach(inp=>{
      inp.addEventListener('input', ()=>{
        const ft = {...getColFilters(mode), [inp.dataset.key]: inp.value};
        setColFilters(mode, ft);
        renderTable(rows, mode);
      });
    });

    enableColumnResize(qs('tableOut'), mode);
    enableHeaderSort(qs('tableOut'), mode);
  }

  // ---------- Export ----------
  function exportCsv(rows, mode='child', cols){
    const useCols = cols && cols.length ? cols : COLS[mode];
    const header = useCols.map(c => c.label);
    const data = rows.map(r => useCols.map(c => {
      let v = r[c.key];
      if (c.pct) return Number(v || 0).toFixed(2) + '%';
      if (c.fmt === '2') return Number(v || 0).toFixed(2);
      if (c.fmt === '0') return String(fmt0(v)).replace(/,/g, '');
      return v == null ? '' : String(v);
    }));
    const escapeCell = v => (typeof v === 'string' && /[",\n]/.test(v) ? '"' + v.replace(/"/g, '""') + '"' : v);
    const csv = [header, ...data].map(row => row.map(escapeCell).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'asin-performance.csv';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  }

  // ---------- Resizing ----------
  function setColWidth(table, idx, width){ const rows = table.rows; for(let r=0;r<rows.length;r++){ const cell=rows[r].cells[idx]; if(cell){ cell.style.width = width+'px'; }}}
  function saveColWidth(mode, idx, width){ (window._colWidths ||= {})[mode] ||= {}; window._colWidths[mode][idx]=width; }
  function getColWidths(mode){ return (window._colWidths && window._colWidths[mode]) || {}; }
  function enableColumnResize(container, mode){
    const table = container.querySelector('table'); if(!table||!table.tHead) return;
    const ths = Array.from(table.tHead.rows[0].cells);
    const cache = getColWidths(mode);
    Object.keys(cache).forEach(i=> setColWidth(table, +i, cache[i]));
    ths.forEach((th,i)=>{
      const handle = document.createElement('span');
      handle.className='col-resize-handle';
      th.appendChild(handle);
      handle.addEventListener('mousedown', (e)=>{
        e.preventDefault();
        const startX = e.pageX; const startW = th.offsetWidth;
        function onMove(ev){ const w = Math.max(60, startW + (ev.pageX - startX)); setColWidth(table,i,w); saveColWidth(mode,i,w); document.body.style.cursor='col-resize'; }
        function onUp(){ document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); document.body.style.cursor=''; }
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
      });
    });
  }

  // ---------- Events ----------
  qs('processBtn').addEventListener('click', process);

  qs('groupMode').addEventListener('change', ()=>{
    if(!window._rowsChild) return;
    const mode = qs('groupMode').value;
    const rows = mode==='parent' ? window._rowsParent : (mode==='category' ? window._rowsCategory : window._rowsChild);
    window._rows = rows;
    renderTable(rows, mode);
    qs('exportBtn').onclick=()=> exportCsv(rows, mode, window._lastColsUsed);
    qs('colsPanel').style.display='none';
    buildColsPanel(mode);
  });

  qs('colsBtn').addEventListener('click', ()=> toggleColsPanel());

  qs('search').addEventListener('input', ()=>{
    if(window._rows){
      const mode=qs('groupMode').value;
      renderTable(window._rows, mode);
    }
  });

  // New: color band toggles (Conv/TACoS/Spend)
  function updateToggle(btn, on){ btn.classList.toggle('active', on); btn.setAttribute('aria-pressed', String(on)); }
  const bandConvBtn = qs('bandConvBtn');
  const bandTacosBtn = qs('bandTacosBtn');
  const bandSpendBtn = qs('bandSpendBtn');
  bandConvBtn.addEventListener('click', ()=>{
    BAND_CONV = !BAND_CONV; updateToggle(bandConvBtn, BAND_CONV);
    if(window._rows){ renderTable(window._rows, qs('groupMode').value); }
  });
  bandTacosBtn.addEventListener('click', ()=>{
    BAND_TACOS = !BAND_TACOS; updateToggle(bandTacosBtn, BAND_TACOS);
    if(window._rows){ renderTable(window._rows, qs('groupMode').value); }
  });
  bandSpendBtn.addEventListener('click', ()=>{
    BAND_SPEND = !BAND_SPEND; updateToggle(bandSpendBtn, BAND_SPEND);
    if(window._rows){ renderTable(window._rows, qs('groupMode').value); }
  });

  // Samples
  qs('downloadSample').addEventListener('click', ()=>{
    const br = `Child ASIN,Parent ASIN,Title,Sessions - Total,Page Views - Total,Featured Offer (Buy Box) Percentage,Units Ordered,Unit Session Percentage,Ordered Product Sales,Total Order Items
B00AAA111,PARENT1,Sample Product A,100,250,85,10,10,500,12
B00BBB222,PARENT2,Sample Product B,200,500,60,5,5,200,6`;
    const sp = `Entity,ASIN (Informational only),Impressions,Clicks,Spend,Sales,Orders,Units
Product Ad,B00AAA111,10000,200,50,400,8,9
Product Ad,B00BBB222,5000,80,30,120,3,3`;
    const map = `Parent,Child Asin,Category Name
PARENT1,,UC
PARENT2,,UC`;
    const a1=document.createElement('a');a1.href=URL.createObjectURL(new Blob([br],{type:'text/csv'}));a1.download='business-report-sample.csv';a1.click();
    const a2=document.createElement('a');a2.href=URL.createObjectURL(new Blob([sp],{type:'text/csv'}));a2.download='sponsored-products-sample.csv';a2.click();
    const a3=document.createElement('a');a3.href=URL.createObjectURL(new Blob([map],{type:'text/csv'}));a3.download='mapping-sample.csv';a3.click();
  });

  window.addEventListener('error',(e)=>{ try{ qs('errors').textContent='Script error: '+(e.message||''); }catch(_){} });
  </script>
</body>
</html>
