<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Campaign Builder â€¢ SP Bulk Generator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#0b0d10; --panel:#11151a; --panel-2:#0f1320; --accent:#4f66ff; --accent-2:#5c7cfa; --muted:#94a3b8; --text:#e5e7eb; --line:#1f2937; --good:#22c55e; --warn:#f59e0b;
      --chip:#1b2430; --chip-on:#1e293b; --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0a0c12 0%, #0b0d10 60%, #0a0c12 100%);color:var(--text);font:14px/1.5 'Inter',system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:1200px;margin:32px auto;padding:0 16px}
    .title{font-weight:700;font-size:20px;margin:0 0 18px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 10px 24px rgba(0,0,0,.35)}
    .panel > .hd{padding:14px 16px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#1a2240,#161b2c);display:flex;align-items:center;gap:8px}
    .panel > .hd .idx{background:var(--accent);color:white;display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;border-radius:999px;font-weight:700;margin-right:6px}
    .panel > .hd h2{margin:0;font-size:14px;letter-spacing:.2px;display:flex;align-items:center;gap:8px}
    .panel .bd{padding:16px}
    .row{display:grid;grid-template-columns:220px 1fr;gap:14px;align-items:center;margin-bottom:12px}
    .row.stack{grid-template-columns:1fr}
    label{color:#cbd5e1;font-weight:600;display:flex;align-items:center;gap:8px}
    input[type="text"], input[type="date"], input[type="number"], textarea, select{width:100%;background:#0c1016;border:1px solid #1e293b;color:var(--text);padding:10px 12px;border-radius:10px;outline:none;transition:.15s}
    textarea{min-height:92px;resize:vertical}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{user-select:none;cursor:pointer;background:var(--chip);border:1px solid #233044;padding:8px 12px;border-radius:999px}
    .chip.active{background:var(--accent);border-color:#2f3cee;color:white}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    .btn{cursor:pointer;background:linear-gradient(180deg,#293a8b,#23306a);border:1px solid #394b9a;color:white;padding:10px 14px;border-radius:10px;font-weight:600}
    .btn.subtle{background:#0f172a;border-color:#1e293b;color:#cbd5e1}
    .btn.ghost{background:transparent;border:1px dashed #334155;color:#cbd5e1}
    .btn.good{background:linear-gradient(180deg,#149a4b,#0f7a3b);border-color:#159253}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .three{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .hr{height:1px;background:#1f2a44;margin:14px 0}
    small.badge{background:#0b1428;border:1px solid #20325e;padding:2px 8px;border-radius:999px;color:#9fb0ff;font-weight:600}
    .dategrp{display:grid;grid-template-columns:1fr auto;gap:8px}
    .inline{display:flex;gap:12px;align-items:center}
    .sw{display:flex;align-items:center;gap:8px}

    /* Tooltips */
    .help{position:relative;display:inline-flex;align-items:center}
    .help .q{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:999px;background:#0a1430;border:1px solid #20325e;color:#9fb0ff;font-size:12px;font-weight:700;cursor:pointer}
    .help .pop{position:absolute;left:22px;top:50%;transform:translateY(-50%);min-width:280px;max-width:420px;background:#0b1428;border:1px solid #20325e;color:#dbe1ff;padding:10px 12px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.35);display:none;z-index:5}
    .help .pop h4{margin:0 0 6px 0;font-size:12px;color:#b7c5ff}
    .help .pop ul{margin:0;padding-left:16px}
    .help:hover .pop{display:block}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="title">Amazon Sponsored Products â€” Campaign Builder & Bulk File Generator</h1>

    <!-- 1. Campaign Details -->
    <section class="panel">
      <div class="hd"><span class="idx">1</span> <h2>Campaign Details <span class="help"><span class="q">?</span><span class="pop"><h4>Campaign Details</h4><ul><li><b>Start Date</b>: exported as YYYYMMDD.</li><li><b>Bidding Strategy</b>: copied to Campaign rows.</li><li><b>Campaign Name</b>: auto-formats as <i>Ad type | SKU | Campaign Type</i> unless you override.</li></ul></span></span></h2></div>
      <div class="bd">
        <div class="row">
          <label>Ad Type</label>
          <select id="adType"><option>Sponsored Products</option></select>
        </div>
        <div class="row">
          <label>Start Date</label>
          <div class="dategrp">
            <input id="startDate" type="date" />
            <button class="btn subtle" id="openCal" type="button" title="Open calendar">ðŸ“…</button>
          </div>
        </div>
        <div class="row"><label>Daily Budget (per campaign)</label><input id="dailyBudget" type="number" min="1" step="0.01" placeholder="25" /></div>
        <div class="row"><label>Bidding Strategy</label>
          <select id="biddingStrategy">
            <option>Dynamic bids - down only</option>
            <option>Dynamic bids - up and down</option>
            <option>Fixed bids</option>
          </select>
        </div>
        <div class="row"><label>Campaign Name Structure</label><input id="nameTpl" type="text" placeholder="Auto: AdType | SKU | CampaignType (leave blank to auto)" /></div>
        <div class="row stack"><div class="hint">Leave blank to auto-name as <b>Ad type | SKU | Campaign Type</b>. Single-KW adds the KW stub automatically.</div></div>
      </div>
    </section>

    <!-- 2. SKUs -->
    <section class="panel">
      <div class="hd"><span class="idx">2</span> <h2>Product SKUs <span class="help"><span class="q">?</span><span class="pop"><h4>SKUs</h4><ul><li>One SKU per line (or comma-separated).</li><li>We build campaigns <b>per SKU</b> so each campaign name includes it.</li></ul></span></span></h2></div>
      <div class="bd">
        <div class="row"><label>SKUs</label><textarea id="skuList" placeholder="Enter SKUs, commas or line breaks to separate\nSKU-001\nSKU-002, SKU-003"></textarea></div>
      </div>
    </section>

    <!-- 3. Bid & Targeting Settings -->
    <section class="panel">
      <div class="hd"><span class="idx">3</span> <h2>Bid & Targeting Settings</h2></div>
      <div class="bd">
        <div class="two">
          <div class="panel" style="background:var(--panel-2);border-color:#22315c">
            <div class="hd"><h2>Bid Ranges <span class="help"><span class="q">?</span><span class="pop"><h4>Bid Ranges</h4><ul><li>We compute midpoints of each range.</li><li><b>Competitive</b> midpoint is used for Exact, Phrase, Product & Brand.</li><li><b>Low</b> midpoint is used for Broad, BMM and Auto.</li></ul></span></span></h2></div>
            <div class="bd">
              <div class="row"><label>Low Bid Range</label>
                <div class="two"><input id="lowMin" type="number" step="0.01" placeholder="0.25"/><input id="lowMax" type="number" step="0.01" placeholder="0.55"/></div>
              </div>
              <div class="row"><label>Competitive Bid Range</label>
                <div class="two"><input id="compMin" type="number" step="0.01" placeholder="0.60"/><input id="compMax" type="number" step="0.01" placeholder="1.50"/></div>
              </div>
            </div>
          </div>

          <div class="panel" style="background:var(--panel-2);border-color:#22315c">
            <div class="hd"><h2>Search Term Isolation <span class="help"><span class="q">?</span><span class="pop"><h4>Isolation (3â€‘way logic)</h4><ul><li>Keywords in <b>Exact</b> are added as <b>Negative Exact</b> in Phrase, Broad & BMM.</li><li><b>Auto</b> gets all manual Exact terms as negatives.</li><li>Singleâ€‘KW campaigns always negate their terms in other types.</li><li>Turn <b>No Isolation</b> on to allow overlap (no negatives).</li></ul></span></span></h2></div>
            <div class="bd">
              <div class="chips">
                <div class="chip active" data-iso="isolate">Isolate</div>
                <div class="chip" data-iso="no">No Isolation</div>
              </div>
              <div class="hint" style="margin-top:8px">If <b>Isolate</b> is on, we'll place exact/phrase keywords in separate campaigns to minimize overlap.</div>
            </div>
          </div>
        </div>

        <div class="hr"></div>
        <div class="row">
          <label>Placements <span class="help"><span class="q">?</span><span class="pop"><h4>Placement Adjustments</h4><ul><li>Set bid multipliers for <b>Top of Search</b> and <b>Product Pages</b>.</li><li>We export these as <b>Bidding Adjustment</b> rows under each campaign.</li></ul></span></span></label>
          <div class="three">
            <div class="inline"><span style="width:140px;opacity:.8">Top of Search %</span><input id="topSearchPct" type="number" step="1" min="0" max="900" placeholder="0" /></div>
            <div class="inline"><span style="width:140px;opacity:.8">Product Pages %</span><input id="prodPagesPct" type="number" step="1" min="0" max="900" placeholder="0" /></div>
            <div class="inline sw"><input id="singleMode" type="checkbox" /> <label for="singleMode">Build <b>Single-KW</b> campaigns</label></div>
          </div>
          <div class="hint">Single-KW applies to Exact, Phrase, Broad, and Broad Modifier. When OFF, keywords are grouped into Multi-KW campaigns.</div>
        </div>
        <div class="row">
          <label>Multi-KW Settings <span class="help"><span class="q">?</span><span class="pop"><h4>Multiâ€‘KW Controls</h4><ul><li>When Singleâ€‘KW is OFF, we group keywords into campaigns.</li><li>Use <b>Max KWs per campaign</b> to cap each campaignâ€™s size (0 = no limit).</li></ul></span></span></label>
          <div class="inline">
            <span style="width:180px;opacity:.8">Max KWs per campaign</span>
            <input id="maxKws" type="number" min="0" step="1" placeholder="0 (no limit)" />
          </div>
        </div>
      </div>
    </section>

    <!-- 4. Campaign Types -->
    <section class="panel">
      <div class="hd"><span class="idx">4</span> <h2>Campaign Types <span class="help"><span class="q">?</span><span class="pop"><h4>Types</h4><ul><li>Select one or more: Exact, Phrase, Broad, Broad Modifier, Auto, Product, Brand.</li><li>We build campaigns per SKU for each selected type.</li></ul></span></span></h2></div>
      <div class="bd">
        <div class="chips" id="typeChips">
          <div class="chip" data-type="exact">Exact Match</div>
          <div class="chip" data-type="phrase">Phrase Match</div>
          <div class="chip" data-type="broad">Broad Match</div>
          <div class="chip" data-type="bmm">Broad Modifier</div>
          <div class="chip" data-type="auto">Auto Match</div>
          <div class="chip" data-type="product">Product Match</div>
          <div class="chip" data-type="brand">Brand Match</div>
        </div>
        <div class="row" style="margin-top:14px"><label>Keywords (one per line)</label><textarea id="kwList" placeholder="water bottle\n64oz bottle with straw\n..."></textarea></div>
        <div class="row"><label>ASINs for Product Targeting (one per line)</label><textarea id="asinList" placeholder="B0XXXXXXX\nB0YYYYYYY"></textarea></div>
      </div>
    </section>

    <div class="panel"><div class="bd"><div class="btns">
      <button class="btn good" id="generate">Generate Bulk .xlsx</button>
      <button class="btn subtle" id="sample">Load Sample Data</button>
      <button class="btn ghost" id="clear">Clear All</button>
    </div></div></div>

    <div class="panel"><div class="bd">
      <div style="font-weight:700">Output Columns</div>
      <div class="hint">Product, Entity, Operation, Campaign ID, Ad Group ID, Portfolio ID, Ad ID, Keyword ID, Product Targeting ID, Campaign Name, Ad Group Name, Start Date, End Date, Targeting Type, State, Daily Budget, SKU, Ad Group Default Bid, Bid, Keyword Text, Native Language Keyword, Native Language Locale, Match Type, Bidding Strategy, Placement, Percentage, Product Targeting Expression</div>
    </div></div>
  </div>

<script>
  const $ = sel => document.querySelector(sel);
  const $$ = sel => [...document.querySelectorAll(sel)];
  const val = sel => $(sel).value?.trim?.() ?? '';

  // chip toggles
  $$('#typeChips .chip, .chips .chip').forEach(ch => ch.addEventListener('click', () => {
    if(ch.parentElement.id === 'typeChips') ch.classList.toggle('active');
    else { ch.parentElement.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); ch.classList.add('active'); }
  }));

  // calendar button opens native picker
  $('#openCal').addEventListener('click', () => {
    const i = $('#startDate');
    try{
      if(i.showPicker){ i.showPicker(); return; }
    }catch(e){}
    // Fallbacks for browsers/environments without showPicker
    i.focus();
    i.click();  });

  $('#clear').onclick = () => { $$('input, textarea').forEach(n=>n.value=''); $$('#typeChips .chip').forEach(c=>c.classList.remove('active')); $$('.chips .chip[data-iso="isolate"]').forEach(c=>c.classList.add('active')); $('#singleMode').checked=false; };

  $('#sample').onclick = () => {
    $('#startDate').valueAsDate = new Date();
    $('#dailyBudget').value = 25;
    $('#biddingStrategy').value = 'Dynamic bids - down only';
    $('#nameTpl').value = '';
    $('#skuList').value = 'SKU-001\nSKU-002';
    $('#lowMin').value = 0.25; $('#lowMax').value = 0.55; $('#compMin').value = 0.6; $('#compMax').value = 1.5;
    $('#topSearchPct').value = 0; $('#prodPagesPct').value = 0;
    ['exact','phrase','broad','bmm','auto','product'].forEach(t=>document.querySelector(`.chip[data-type="${t}"]`).classList.add('active'));
    $('#kwList').value = 'water bottle\n64 oz glass water bottle\ninsulated bottle straw\nspill proof bottle';
    $('#asinList').value = 'B0ABCDEF12\nB0HIJKLM34';
    $('#singleMode').checked = true; // sample: single-KW mode
    $('#maxKws').value = 20;
  };

  function parseList(s){ return s.split(/[\n,]+/).map(x=>x.trim()).filter(Boolean); }
  function mid(a,b){ a=Number(a); b=Number(b); if(!isFinite(a)||!isFinite(b)) return ''; return ((a+b)/2).toFixed(2); }
  function yyyymmdd(d){ if(!d) return ''; return d.replaceAll('-',''); }
  function shortKw(k){ const clean = k.toLowerCase().replace(/[^a-z0-9\s]/g,' ').replace(/\s+/g,' ').trim(); return clean.slice(0,24); }
  function typePretty(t){
    if(t==='exact') return 'Exact';
    if(t==='phrase') return 'Phrase';
    if(t==='broad') return 'Broad';
    if(t==='bmm') return 'Broad Mod';
    if(t==='auto') return 'Auto';
    if(t==='product') return 'Product';
    if(t==='brand') return 'Brand';
    return t;
  }
  function bmmify(k){
    return k.split(/\s+/).map(tok=> tok.startsWith('+')? tok : ('+'+tok)).join(' ').trim();
  }
  function chunk(arr, size){ if(!size || size<=0) return [arr]; const out=[]; for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size)); return out; }

  function buildRows(){
    const startDate = yyyymmdd(val('#startDate'));
    const budget = Number(val('#dailyBudget'))||'';
    const strategy = val('#biddingStrategy');
    const adType = val('#adType') || 'Sponsored Products';

    const skus = parseList(val('#skuList'));
    const kwsRaw = parseList(val('#kwList'));
    const asins = parseList(val('#asinList'));

    const iso = document.querySelector('.chips .chip.active')?.dataset.iso === 'isolate';

    const low = {min:val('#lowMin'), max:val('#lowMax')};
    const comp= {min:val('#compMin'),max:val('#compMax')};

    const placements=[];
    const topPct = Number(val('#topSearchPct'))||0; if(topPct>0) placements.push({place:'Top of Search (First Page)', pct: topPct});
    const prodPct = Number(val('#prodPagesPct'))||0; if(prodPct>0) placements.push({place:'Product Pages', pct: prodPct});

    const singleMode = $('#singleMode').checked;
    const maxKws = parseInt(val('#maxKws')) || 0;

    const types = $$('#typeChips .chip.active').map(x=>x.dataset.type);

    // For isolation: capture lists that should be negated into other types
    const exactList = types.includes('exact') ? [...kwsRaw] : [];

    const rows = [];
    function pushCampaign(campName, targetingType, adGroupBid){
      // Campaign row (IDs = campaign name)
      rows.push({Product:'Sponsored Products', Entity:'Campaign', Operation:'Create', 'Campaign ID':campName, 'Ad Group ID':campName, 'Portfolio ID':'', 'Ad ID':'', 'Keyword ID':'', 'Product Targeting ID':'', 'Campaign Name':campName, 'Ad Group Name':'', 'Start Date':startDate, 'End Date':'', 'Targeting Type':targetingType, State:'enabled', 'Daily Budget':budget, SKU:'', 'Ad Group Default Bid':'', Bid:'', 'Keyword Text':'', 'Native Language Keyword':'', 'Native Language Locale':'', 'Match Type':'', 'Bidding Strategy':strategy, 'Placement':'', 'Percentage':'', 'Product Targeting Expression':''});
      // Bidding adjustments rows
      placements.forEach(p=>rows.push({Product:'Sponsored Products', Entity:'Bidding Adjustment', Operation:'Create', 'Campaign ID':campName, 'Ad Group ID':campName, 'Portfolio ID':'', 'Ad ID':'', 'Keyword ID':'', 'Product Targeting ID':'', 'Campaign Name':campName, 'Ad Group Name':'', 'Start Date':'', 'End Date':'', 'Targeting Type':'', State:'enabled', 'Daily Budget':'', SKU:'', 'Ad Group Default Bid':'', Bid:'', 'Keyword Text':'', 'Native Language Keyword':'', 'Native Language Locale':'', 'Match Type':'', 'Bidding Strategy':'', 'Placement':p.place, 'Percentage':p.pct, 'Product Targeting Expression':''}));
      // Ad Group row (IDs/name = campaign name)
      rows.push({Product:'Sponsored Products', Entity:'Ad Group', Operation:'Create', 'Campaign ID':campName, 'Ad Group ID':campName, 'Portfolio ID':'', 'Ad ID':'', 'Keyword ID':'', 'Product Targeting ID':'', 'Campaign Name':campName, 'Ad Group Name':campName, 'Start Date':'', 'End Date':'', 'Targeting Type':'', State:'enabled', 'Daily Budget':'', SKU:'', 'Ad Group Default Bid': adGroupBid, Bid:'', 'Keyword Text':'', 'Native Language Keyword':'', 'Native Language Locale':'', 'Match Type':'', 'Bidding Strategy':'', 'Placement':'', 'Percentage':'', 'Product Targeting Expression':''});
    }

    function addAdRow(campName, sku){
      rows.push({Product:'Sponsored Products', Entity:'Product Ad', Operation:'Create', 'Campaign ID':campName, 'Ad Group ID':campName, 'Portfolio ID':'', 'Ad ID':'', 'Keyword ID':'', 'Product Targeting ID':'', 'Campaign Name':campName, 'Ad Group Name':campName, 'Start Date':'', 'End Date':'', 'Targeting Type':'', State:'enabled', 'Daily Budget':'', SKU:sku, 'Ad Group Default Bid':'', Bid:'', 'Keyword Text':'', 'Native Language Keyword':'', 'Native Language Locale':'', 'Match Type':'', 'Bidding Strategy':'', 'Placement':'', 'Percentage':'', 'Product Targeting Expression':''});
    }

    function addKeywordRow(campName, matchType, bidMid, k){
      rows.push({Product:'Sponsored Products', Entity:'Keyword', Operation:'Create', 'Campaign ID':campName, 'Ad Group ID':campName, 'Portfolio ID':'', 'Ad ID':'', 'Keyword ID':'', 'Product Targeting ID':'', 'Campaign Name':campName, 'Ad Group Name':campName, 'Start Date':'', 'End Date':'', 'Targeting Type':'', State:'enabled', 'Daily Budget':'', SKU:'', 'Ad Group Default Bid':'', Bid:bidMid, 'Keyword Text':k, 'Native Language Keyword':'', 'Native Language Locale':'', 'Match Type':matchType, 'Bidding Strategy':'', 'Placement':'', 'Percentage':'', 'Product Targeting Expression':''});
    }

    function addNegativeRow(campName, negType, k){
      rows.push({Product:'Sponsored Products', Entity:'Keyword', Operation:'Create', 'Campaign ID':campName, 'Ad Group ID':campName, 'Portfolio ID':'', 'Ad ID':'', 'Keyword ID':'', 'Product Targeting ID':'', 'Campaign Name':campName, 'Ad Group Name':campName, 'Start Date':'', 'End Date':'', 'Targeting Type':'', State:'enabled', 'Daily Budget':'', SKU:'', 'Ad Group Default Bid':'', Bid:'', 'Keyword Text':k, 'Native Language Keyword':'', 'Native Language Locale':'', 'Match Type':negType, 'Bidding Strategy':'', 'Placement':'', 'Percentage':'', 'Product Targeting Expression':''});
    }

    function addProductTargetRow(campName, bidMid, asin){
      rows.push({Product:'Sponsored Products', Entity:'Product Targeting', Operation:'Create', 'Campaign ID':campName, 'Ad Group ID':campName, 'Portfolio ID':'', 'Ad ID':'', 'Keyword ID':'', 'Product Targeting ID':'', 'Campaign Name':campName, 'Ad Group Name':campName, 'Start Date':'', 'End Date':'', 'Targeting Type':'', State:'enabled', 'Daily Budget':'', SKU:'', 'Ad Group Default Bid':'', Bid:bidMid, 'Keyword Text':'', 'Native Language Keyword':'', 'Native Language Locale':'', 'Match Type':'', 'Bidding Strategy':'', 'Placement':'', 'Percentage':'', 'Product Targeting Expression':`ASIN == ${asin}`});
    }

    const bidMidLow = mid(low.min, low.max);
    const bidMidComp= mid(comp.min, comp.max);

    if(types.length===0) alert('Select at least one Campaign Type');

    // Build per type and per SKU (name includes SKU)
    types.forEach(t => {
      const isoLabel = iso ? 'ISO' : 'NOISO';
      const targetType = t === 'auto' ? 'AUTO' : 'Manual';
      const pretty = typePretty(t);
      const baseBid = (t==='exact'||t==='phrase'||t==='product'||t==='brand') ? (bidMidComp||bidMidLow) : (t==='auto' ? (bidMidLow||bidMidComp) : (bidMidLow||bidMidComp));

      // prepare keyword list considering BMM
      const kws = (t==='bmm') ? kwsRaw.map(bmmify) : [...kwsRaw];
      const matchTypeFor = (t==='bmm')? 'Broad' : (pretty);

      skus.forEach((sku)=>{
        if(t==='auto'){
          const expressions = ['close-match','loose-match','substitutes','complements'];
          const bid = baseBid;
          if(singleMode){
            expressions.forEach(expr=>{
              const campName = `${adType} | ${sku} | Auto - ${expr} - ${isoLabel}`;
              pushCampaign(campName, targetType, bid);
              addAdRow(campName, sku);
              rows.push({Product:'Sponsored Products', Entity:'Product Targeting', Operation:'Create', 'Campaign ID':campName, 'Ad Group ID':campName, 'Portfolio ID':'', 'Ad ID':'', 'Keyword ID':'', 'Product Targeting ID':'', 'Campaign Name':campName, 'Ad Group Name':campName, 'Start Date':'', 'End Date':'', 'Targeting Type':'', State:'enabled', 'Daily Budget':'', SKU:'', 'Ad Group Default Bid':'', Bid:bid, 'Keyword Text':'', 'Native Language Keyword':'', 'Native Language Locale':'', 'Match Type':'', 'Bidding Strategy':'', 'Placement':'', 'Percentage':'', 'Product Targeting Expression':expr});
              if(iso){ exactList.forEach(k=>addNegativeRow(campName,'Negative Exact',k)); }
              rows.push({});
            });
          } else {
            const campName = `${adType} | ${sku} | Auto - ${isoLabel}`;
            pushCampaign(campName, targetType, bid);
            addAdRow(campName, sku);
            expressions.forEach(expr=>{
              rows.push({Product:'Sponsored Products', Entity:'Product Targeting', Operation:'Create', 'Campaign ID':campName, 'Ad Group ID':campName, 'Portfolio ID':'', 'Ad ID':'', 'Keyword ID':'', 'Product Targeting ID':'', 'Campaign Name':campName, 'Ad Group Name':campName, 'Start Date':'', 'End Date':'', 'Targeting Type':'', State:'enabled', 'Daily Budget':'', SKU:'', 'Ad Group Default Bid':'', Bid:bid, 'Keyword Text':'', 'Native Language Keyword':'', 'Native Language Locale':'', 'Match Type':'', 'Bidding Strategy':'', 'Placement':'', 'Percentage':'', 'Product Targeting Expression':expr});
            });
            if(iso){ exactList.forEach(k=>addNegativeRow(campName,'Negative Exact',k)); }
            rows.push({});
          }
          return;
        }

        if(t==='product'){
          const bid = bidMidComp||baseBid;
          if(singleMode){
            asins.forEach(asin=>{
              const campName = `${adType} | ${sku} | Product - ${asin} - ${isoLabel}`;
              pushCampaign(campName, 'Manual', bid);
              addAdRow(campName, sku);
              addProductTargetRow(campName, bid, asin);
              rows.push({});
            });
          } else {
            const groups = chunk(asins, maxKws||asins.length);
            groups.forEach((grp, i)=>{
              const suffix = groups.length>1 ? ` - set ${i+1}` : '';
              const campName = `${adType} | ${sku} | Product${suffix} - ${isoLabel}`;
              pushCampaign(campName, 'Manual', bid);
              addAdRow(campName, sku);
              grp.forEach(asin=>addProductTargetRow(campName, bid, asin));
              rows.push({});
            });
          }
          return;
        }

        if(t==='brand'){
          const campName = `${adType} | ${sku} | ${pretty} - ${isoLabel}`;
          pushCampaign(campName, 'Manual', bidMidComp||baseBid);
          addAdRow(campName, sku);
          asins.forEach(asin=>addProductTargetRow(campName, bidMidComp||baseBid, asin));
          rows.push({});
          return;
        }

        // Keyword-based types
        if(singleMode){
          kws.forEach(k=>{
            const campName = `${adType} | ${sku} | ${pretty} - ${shortKw(k)} - ${isoLabel}`;
            pushCampaign(campName, 'Manual', baseBid);
            addAdRow(campName, sku);
            addKeywordRow(campName, matchTypeFor, baseBid, k);
            if(iso && (t==='phrase' || t==='broad' || t==='bmm')){
              exactList.forEach(ex=>addNegativeRow(campName,'Negative Exact', ex));
            }
            rows.push({});
          });
        } else {
          const groups = chunk(kws, maxKws||kws.length);
          groups.forEach((grp, i)=>{
            const suffix = groups.length>1 ? ` - set ${i+1}` : '';
            const campName = `${adType} | ${sku} | ${pretty}${suffix} - ${isoLabel}`;
            pushCampaign(campName, 'Manual', baseBid);
            addAdRow(campName, sku);
            grp.forEach(k=>addKeywordRow(campName, matchTypeFor, baseBid, k));
            if(iso && (t==='phrase' || t==='broad' || t==='bmm')){
              exactList.forEach(ex=>addNegativeRow(campName,'Negative Exact', ex));
            }
            rows.push({});
          });
        }
      });
    });

    return rows;
  }

  function toSheet(rows){
    const headers = [
      'Product','Entity','Operation','Campaign ID','Ad Group ID','Portfolio ID','Ad ID','Keyword ID','Product Targeting ID','Campaign Name','Ad Group Name','Start Date','End Date','Targeting Type','State','Daily Budget','SKU','Ad Group Default Bid','Bid','Keyword Text','Native Language Keyword','Native Language Locale','Match Type','Bidding Strategy','Placement','Percentage','Product Targeting Expression'
    ];
    const data = [headers];
    rows.forEach(r=>{
      if(Object.keys(r).length===0){ data.push(Array(headers.length).fill('')); return; } // blank separator row
      const row = headers.map(h=> r[h] ?? '');
      data.push(row);
    });
    return data;
  }

  function downloadXlsx(rows){
    const ws = XLSX.utils.aoa_to_sheet(toSheet(rows));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Bulk');
    const fname = 'ads-bulk.xlsx';
    XLSX.writeFile(wb, fname);
  }

  $('#generate').onclick = () => {
    const rows = buildRows();
    if(!rows || !rows.length) return;
    downloadXlsx(rows);
  };
</script>
</body>
</html>

